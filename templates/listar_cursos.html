{% extends "index_master.html" %}
{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid">
    {% csrf_token %}
    
    <!-- Mensajes -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          <i class="fas fa-{{ message.tags|default:'info'|yesno:'check-circle,exclamation-triangle,info-circle' }} me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Header Simple -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-1">
              <i class="fas fa-school me-2 text-primary"></i>Cursos {{ anio_actual }}
            </h2>
            <p class="text-muted mb-0">{{ total_cursos }} curso{{ total_cursos|pluralize }}, {{ total_estudiantes_asignados }} estudiante{{ total_estudiantes_asignados|pluralize }}</p>
          </div>
          {% if puede_editar %}
            <a href="{% url 'agregar_curso' %}" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Nuevo Curso
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tabla de Cursos Simple -->
    <div class="card">
      <div class="card-body p-0">
        {% if cursos %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="fw-semibold">Curso</th>
                  <th class="fw-semibold">Profesor Jefe</th>
                  <th class="fw-semibold text-center">Estudiantes</th>
                  <th class="fw-semibold text-center">Asignaturas</th>
                  {% if puede_editar %}
                  <th class="fw-semibold text-center">Acciones</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for curso in cursos %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        {% if curso.nivel|slice:"-1" == "B" %}
                          <span class="badge bg-primary me-2">Básico</span>
                        {% else %}
                          <span class="badge bg-info me-2">Medio</span>
                        {% endif %}
                        <strong>{{ curso.get_nivel_display }}{{ curso.paralelo }}</strong>
                      </div>
                    </td>
                    <td>
                      {% if curso.profesor_jefe %}
                        <span class="text-success">
                          <i class="fas fa-user-tie me-1"></i>{{ curso.profesor_jefe.get_nombre_completo }}
                        </span>
                      {% else %}
                        <span class="text-warning">
                          <i class="fas fa-exclamation-triangle me-1"></i>Sin asignar
                        </span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-success">{{ curso.estudiantes.count }}</span>
                      {% if curso.estudiantes.count > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-1" 
                                onclick="toggleDetalle('estudiantes-{{ curso.id }}', this)">
                          <i class="fas fa-eye"></i>
                        </button>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">{{ curso.asignaturas.count }}</span>
                      {% if curso.asignaturas.count > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-1" 
                                onclick="toggleDetalle('asignaturas-{{ curso.id }}', this)">
                          <i class="fas fa-eye"></i>
                        </button>
                      {% endif %}
                    </td>
                    {% if puede_editar %}
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="gestionarAsignaturas({{ curso.id }}, '{{ curso.get_nivel_display }}{{ curso.paralelo }}')"
                                title="Gestionar asignaturas">
                          <i class="fas fa-book"></i>
                        </button>
                        <a href="{% url 'editar_curso' curso.id %}" class="btn btn-outline-secondary" title="Editar">
                          <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="eliminarCurso('{{ curso.get_nivel_display }}{{ curso.paralelo }}', {{ curso.id }})"
                                title="Eliminar">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                    {% endif %}
                  </tr>
                  
                  <!-- Detalle de estudiantes -->
                  {% if curso.estudiantes.count > 0 %}
                  <tr id="estudiantes-{{ curso.id }}" class="table-light collapse-row" style="display: none;">
                    <td colspan="{% if puede_editar %}5{% else %}4{% endif %}">
                      <div class="p-3">
                        <h6 class="text-primary mb-3">
                          <i class="fas fa-users me-1"></i>Estudiantes ({{ curso.estudiantes.count }})
                        </h6>
                        <div class="row">
                          {% for estudiante in curso.estudiantes.all %}
                            <div class="col-md-4 mb-2">
                              <span class="small">
                                <i class="fas fa-user-graduate text-success me-1"></i>
                                {{ estudiante.get_nombre_completo }}
                              </span>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endif %}
                  
                  <!-- Detalle de asignaturas -->
                  {% if curso.asignaturas.count > 0 %}
                  <tr id="asignaturas-{{ curso.id }}" class="table-light collapse-row" style="display: none;">
                    <td colspan="{% if puede_editar %}5{% else %}4{% endif %}">
                      <div class="p-3">
                        <h6 class="text-info mb-3">
                          <i class="fas fa-book me-1"></i>Asignaturas ({{ curso.asignaturas.count }})
                        </h6>
                        <div class="row">
                          {% for asignatura in curso.asignaturas.all %}
                            <div class="col-md-6 mb-2">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small">
                                  <i class="fas fa-book-open text-info me-1"></i>
                                  <strong>{{ asignatura.nombre }}</strong>
                                  {% if asignatura.profesor_responsable %}
                                    <br><small class="text-muted ms-3">{{ asignatura.profesor_responsable.get_nombre_completo }}</small>
                                  {% endif %}
                                </span>
                                {% if puede_editar %}
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="removerAsignatura({{ curso.id }}, {{ asignatura.id }}, '{{ asignatura.nombre }}')"
                                        title="Remover">
                                  <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <i class="fas fa-school fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No hay cursos registrados</h5>
            <p class="text-muted">Comienza agregando el primer curso del año académico.</p>
            {% if puede_editar %}
              <a href="{% url 'agregar_curso' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Agregar Primer Curso
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Modal Simple para Gestionar Asignaturas -->
    <div class="modal fade" id="modalAsignaturas" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-book me-2"></i>Gestionar Asignaturas - <span id="modalCursoNombre"></span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-3">Asignaturas Disponibles</h6>
                <div id="asignaturasDisponibles">
                  <div class="text-center p-3">
                    <i class="fas fa-spinner fa-spin"></i> Cargando...
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="text-success mb-3">Asignaturas Asignadas</h6>
                <div id="asignaturasAsignadas">
                  <div class="text-center p-3">
                    <i class="fas fa-spinner fa-spin"></i> Cargando...
                  </div>
                </div>
              </div>
            </div>
            <input type="hidden" id="modalCursoId">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de estudiantes pendientes (si los hay) -->
    {% if estudiantes_pendientes and puede_editar %}
    <div class="alert alert-warning mt-4">
      <h6 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>Estudiantes Pendientes ({{ total_estudiantes_pendientes }})
      </h6>
      <p class="mb-0">Hay estudiantes que no están asignados a ningún curso. 
        <a href="{% url 'agregar_curso' %}" class="alert-link">Crear un nuevo curso</a> o editar uno existente para asignarlos.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- JavaScript Simplificado -->
<script>
// Función para mostrar/ocultar detalles
function toggleDetalle(id, btn) {
  const fila = document.getElementById(id);
  const icon = btn.querySelector('i');
  
  if (fila.style.display === "none") {
    fila.style.display = "";
    icon.className = "fas fa-eye-slash";
  } else {
    fila.style.display = "none";
    icon.className = "fas fa-eye";
  }
}

// Función para gestionar asignaturas
function gestionarAsignaturas(cursoId, cursoNombre) {
  document.getElementById('modalCursoId').value = cursoId;
  document.getElementById('modalCursoNombre').textContent = cursoNombre;
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('modalAsignaturas'));
  modal.show();
  
  // Cargar asignaturas
  cargarAsignaturas(cursoId);
}

// Función para cargar asignaturas vía AJAX
function cargarAsignaturas(cursoId) {
  const disponiblesContainer = document.getElementById('asignaturasDisponibles');
  const asignadasContainer = document.getElementById('asignaturasAsignadas');
  
  // Obtener token CSRF
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/ajax/obtener-asignaturas-curso/${cursoId}/`, {
    method: 'GET',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarAsignaturas(data.data, cursoId);
    } else {
      disponiblesContainer.innerHTML = '<div class="text-center text-danger p-3">Error al cargar</div>';
      asignadasContainer.innerHTML = '<div class="text-center text-danger p-3">Error al cargar</div>';
    }
  })
  .catch(error => {
    disponiblesContainer.innerHTML = '<div class="text-center text-danger p-3">Error de conexión</div>';
    asignadasContainer.innerHTML = '<div class="text-center text-danger p-3">Error de conexión</div>';
  });
}

// Función para mostrar las asignaturas en el modal
function mostrarAsignaturas(data, cursoId) {
  const disponiblesContainer = document.getElementById('asignaturasDisponibles');
  const asignadasContainer = document.getElementById('asignaturasAsignadas');
  
  // Limpiar contenedores
  disponiblesContainer.innerHTML = '';
  asignadasContainer.innerHTML = '';
  
  // Mostrar disponibles
  if (data.asignaturas_disponibles.length > 0) {
    data.asignaturas_disponibles.forEach(asignatura => {
      const div = document.createElement('div');
      div.className = 'mb-2';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-2 border rounded">
          <span>${asignatura.nombre}</span>
          <button type="button" class="btn btn-sm btn-success" 
                  onclick="asignarAsignatura(${asignatura.id}, '${asignatura.nombre}', ${cursoId})">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      `;
      disponiblesContainer.appendChild(div);
    });
  } else {
    disponiblesContainer.innerHTML = '<div class="text-muted text-center p-3">Todas asignadas</div>';
  }
  
  // Mostrar asignadas
  if (data.asignaturas_asignadas.length > 0) {
    data.asignaturas_asignadas.forEach(asignatura => {
      const div = document.createElement('div');
      div.className = 'mb-2';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-2 border rounded bg-light">
          <span>${asignatura.nombre}</span>
          <button type="button" class="btn btn-sm btn-danger" 
                  onclick="desasignarAsignatura(${asignatura.id}, '${asignatura.nombre}', ${cursoId})">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      asignadasContainer.appendChild(div);
    });
  } else {
    asignadasContainer.innerHTML = '<div class="text-muted text-center p-3">Ninguna asignada</div>';
  }
}

// Función para asignar asignatura
function asignarAsignatura(asignaturaId, nombre, cursoId) {
  if (!confirm(`¿Asignar ${nombre} al curso?`)) return;
  
  gestionarAsignaturaCurso(cursoId, asignaturaId, 'asignar');
}

// Función para desasignar asignatura
function desasignarAsignatura(asignaturaId, nombre, cursoId) {
  if (!confirm(`¿Desasignar ${nombre} del curso?`)) return;
  
  gestionarAsignaturaCurso(cursoId, asignaturaId, 'desasignar');
}

// Función para remover asignatura desde la tabla
function removerAsignatura(cursoId, asignaturaId, nombre) {
  if (!confirm(`¿Remover ${nombre} del curso?`)) return;
  
  gestionarAsignaturaCurso(cursoId, asignaturaId, 'desasignar');
}

// Función general para gestionar asignatura-curso
function gestionarAsignaturaCurso(cursoId, asignaturaId, accion) {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch('/ajax/gestionar-asignaturas-curso/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      curso_id: cursoId,
      asignatura_id: asignaturaId,
      accion: accion
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Recargar la página para actualizar los datos
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    alert('Error de conexión');
  });
}

// Función para eliminar curso
function eliminarCurso(nombreCurso, cursoId) {
  if (confirm(`¿Eliminar el curso "${nombreCurso}"?\n\nEsta acción eliminará:\n- Todas las asignaciones de estudiantes\n- Todas las asignaciones de asignaturas\n\n¿Continuar?`)) {
    window.location.href = `/cursos/eliminar/${cursoId}/`;
  }
}
</script>

<!-- Estilos Limpios -->
<style>
.table th {
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
}

.collapse-row {
  background-color: #f8f9fa !important;
}

.btn-group-sm > .btn {
  padding: 0.25rem 0.5rem;
}

.badge {
  font-size: 0.875em;
}

.modal-content {
  border: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.card {
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  .btn-group-sm > .btn {
    padding: 0.125rem 0.25rem;
  }
}
</style>
{% endblock %}
